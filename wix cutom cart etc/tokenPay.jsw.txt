//tokenPay.jsw

import { fetch } from 'wix-fetch';
import wixSecretsBackend from 'wix-secrets-backend';
// import { getAccessToken } from 'backend/createTestAccessToken'
// export async function makePayment(token, amount, email,city,state,zip,country,name,phone,orderNumber,addressLine) {
export async function makePayment(token,email,amount,phone,name,orderNumber) {
    const apiKey =  await wixSecretsBackend.getSecret('checkoutApiKey');
    function transformNumber(inputNumber) {
  // Check if the inputNumber has a decimal point
  if (Number.isInteger(inputNumber)) {
    // It's a whole number, add two zeros at the end
    return inputNumber;
  } else {
    // It's a decimal number, remove the decimal point
    return Math.floor(inputNumber * 100);
  }
}

const convertedAmount = transformNumber(amount);
// console.log(convertedAmount);
    try {
        // const apiKey = ''
        const url = 'https://api.checkout.com/payments';

        const headers = {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
        };

        const requestBody = {
            "source": {
      "type": "token",
      "token": token
    },
    "amount": convertedAmount,
    "currency": "EUR",
    "processing_channel_id": "pc_t2qqhw2e6cruvlmnumsjw6zdc4",
    "reference": `Payment for Wix Order: ${orderNumber}`,
    "description": `Payment for Wix Order: ${orderNumber}`,
    "capture": true,
    "customer": {
      "email": email,
      "name": name,
      "phone": {
        "country_code": "+1",
        "number": phone
      }
    },

    "3ds": {
      "enabled": false,
      // "attempt_n3d": true
    },
    "success_url": "https://www.curefip.com/success",
    "failure_url": "https://www.curefip.com/failed",
    "payment_ip": "",
   
        };

        const requestOptions = {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestBody)
        };

        const response = await fetch(url, requestOptions);
        // console.log(response);
        const res = response.json()
        return res;
    } catch (error) {
        console.log(error)

    }

}